trigger:
  branches:
    include:
      - main

resources:
- repo: self

variables:
  imageRepository: 'xpensify-auth-api'
  containerRegistry: 'xpensifyacr.azurecr.io'
  dockerfilePath: '$(Build.SourcesDirectory)/Dockerfile'
  tag: 'v1-$(Build.BuildId)'  # âœ… tag unique Ã  chaque build

stages:
- stage: BuildAndPush
  displayName: ğŸ³ Build & Push Docker Image
  jobs:
  - job: Build
    displayName: ğŸ“¦ Build Job
    pool:
      name: default
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: ğŸ” Docker Login to ACR
      inputs:
        azureSubscription: 'xpensify-azure-rm'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ğŸ” Connexion Ã  ACR..."
          az acr login --name xpensifyacr

    - script: |
        echo "ğŸ—ï¸ Build image: $(containerRegistry)/$(imageRepository):$(tag)"
        docker build --no-cache -f $(dockerfilePath) -t $(containerRegistry)/$(imageRepository):$(tag) .
      displayName: ğŸ›  Docker Build

    - script: |
        echo "ğŸ“¤ Push image: $(containerRegistry)/$(imageRepository):$(tag)"
        docker push $(containerRegistry)/$(imageRepository):$(tag)
      displayName: ğŸš€ Docker Push

    - task: AzureCLI@2
      displayName: ğŸŒ Deploy to Azure Container App (auth-service)
      inputs:
        azureSubscription: 'xpensify-azure-rm'
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          echo "ğŸš€ Deploy image to Container App..."
          az containerapp update \
            --name auth-service \
            --resource-group BachirPro \
            --image $(containerRegistry)/$(imageRepository):$(tag)
