trigger:
  - main

variables:
  imageName: xpensify-auth-api
  acrName: xpensifyacr.azurecr.io
  dockerfilePath: $(Build.SourcesDirectory)/Dockerfile
  tag: v1

stages:
  - stage: BuildAndPush
    displayName: 📦 Build & Push Docker image
    jobs:
      - job: DockerJob
        displayName: 🔨 Docker build & push
        pool:
          vmImage: ubuntu-latest

        steps:
          - checkout: self

          - task: AzureKeyVault@2
            name: LoadSecrets
            inputs:
              azureSubscription: 'xpensify-azure-rm'
              KeyVaultName: 'xpensify-vault'
              SecretsFilter: '*'
              RunAsPreJob: true

          - task: Docker@2
            displayName: 🐳 Build & push Docker image
            inputs:
              containerRegistry: 'xpensifyacr' # nom du service connection ACR dans Azure DevOps
              repository: $(imageName)
              command: buildAndPush
              Dockerfile: $(dockerfilePath)
              tags: |
                $(tag)
